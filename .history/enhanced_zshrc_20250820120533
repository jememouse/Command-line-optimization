# ============================================================================
# å¢å¼ºç‰ˆ Zsh é…ç½®æ–‡ä»¶
# å®ç°å®æ—¶å‘½ä»¤å»ºè®®ã€æ™ºèƒ½è¡¥å…¨ã€ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç­‰åŠŸèƒ½
# ============================================================================

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# ============================================================================
# Oh My Zsh é…ç½®
# ============================================================================
export ZSH="$HOME/.oh-my-zsh"

# è®¾ç½®ä¸»é¢˜
ZSH_THEME="powerlevel10k/powerlevel10k"

# æ’ä»¶é…ç½®
plugins=(
    git                           # Git é›†æˆ
    brew                         # Homebrew è¡¥å…¨
    macos                        # macOS ç‰¹å®šåŠŸèƒ½
    zsh-autosuggestions          # å®æ—¶å‘½ä»¤å»ºè®®
    zsh-syntax-highlighting      # è¯­æ³•é«˜äº®
    zsh-completions              # å¢å¼ºè¡¥å…¨
    zsh-history-substring-search # å†å²æœç´¢
    you-should-use              # åˆ«åæé†’
    colored-man-pages           # å½©è‰² man é¡µé¢
    command-not-found           # å‘½ä»¤æœªæ‰¾åˆ°å»ºè®®
    copypath                    # å¤åˆ¶è·¯å¾„
    copyfile                    # å¤åˆ¶æ–‡ä»¶å†…å®¹
    dirhistory                  # ç›®å½•å†å²
    jsontools                   # JSON å·¥å…·
    web-search                  # ç½‘ç»œæœç´¢
    extract                     # æ™ºèƒ½è§£å‹
)

# åŠ è½½ Oh My Zsh
source $ZSH/oh-my-zsh.sh

# ============================================================================
# å†å²é…ç½® - æ™ºèƒ½å†å²è®°å½•
# ============================================================================
HISTFILE=~/.zsh_history
HISTSIZE=50000                   # å†…å­˜ä¸­çš„å†å²è®°å½•æ•°
SAVEHIST=50000                   # æ–‡ä»¶ä¸­çš„å†å²è®°å½•æ•°

# å†å²é€‰é¡¹
setopt EXTENDED_HISTORY          # è®°å½•æ—¶é—´æˆ³
setopt HIST_EXPIRE_DUPS_FIRST    # åˆ é™¤é‡å¤çš„æ—§è®°å½•
setopt HIST_IGNORE_DUPS          # ä¸è®°å½•é‡å¤çš„å‘½ä»¤
setopt HIST_IGNORE_ALL_DUPS      # åˆ é™¤æ‰€æœ‰é‡å¤
setopt HIST_FIND_NO_DUPS         # æœç´¢æ—¶ä¸æ˜¾ç¤ºé‡å¤
setopt HIST_IGNORE_SPACE         # å¿½ç•¥ä»¥ç©ºæ ¼å¼€å¤´çš„å‘½ä»¤
setopt HIST_SAVE_NO_DUPS         # ä¿å­˜æ—¶ä¸è®°å½•é‡å¤
setopt HIST_REDUCE_BLANKS        # åˆ é™¤å¤šä½™ç©ºæ ¼
setopt HIST_VERIFY               # å†å²æ‰©å±•æ—¶ç¡®è®¤
setopt INC_APPEND_HISTORY        # å®æ—¶è¿½åŠ å†å²
setopt SHARE_HISTORY             # å…±äº«å†å²è®°å½•

# ============================================================================
# è¡¥å…¨ç³»ç»Ÿé…ç½® - æ™ºèƒ½å‚æ•°è¡¥å…¨
# ============================================================================
autoload -U compinit && compinit

# è¡¥å…¨é€‰é¡¹
setopt COMPLETE_IN_WORD          # åœ¨å•è¯ä¸­é—´ä¹Ÿèƒ½è¡¥å…¨
setopt ALWAYS_TO_END             # è¡¥å…¨åå…‰æ ‡ç§»åˆ°æœ«å°¾
setopt PATH_DIRS                 # åœ¨è·¯å¾„ä¸­æœç´¢è¡¥å…¨
setopt AUTO_MENU                 # è‡ªåŠ¨èœå•
setopt AUTO_LIST                 # è‡ªåŠ¨åˆ—å‡ºé€‰æ‹©
setopt AUTO_PARAM_SLASH          # ç›®å½•åè‡ªåŠ¨æ·»åŠ æ–œæ 
setopt FLOW_CONTROL              # å¯ç”¨æµæ§åˆ¶

# è¡¥å…¨æ ·å¼
zstyle ':completion:*' menu select
zstyle ':completion:*' group-name ''
zstyle ':completion:*' verbose yes
zstyle ':completion:*:descriptions' format '%B%d%b'
zstyle ':completion:*:messages' format '%d'
zstyle ':completion:*:warnings' format 'No matches for: %d'
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}

# æ™ºèƒ½å¤§å°å†™åŒ¹é…
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'

# è¿›ç¨‹è¡¥å…¨
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#) ([0-9a-z-]#)*=01;34=0=01'
zstyle ':completion:*:*:*:*:processes' command "ps -u $USER -o pid,user,comm -w -w"

# ============================================================================
# ç¯å¢ƒå˜é‡å’Œè·¯å¾„
# ============================================================================
# ç¼–è¾‘å™¨
export EDITOR='code'
export VISUAL='code'

# è¯­è¨€ç¯å¢ƒ
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# è·¯å¾„é…ç½®
export PATH="/opt/homebrew/bin:$PATH"
export PATH="/usr/local/bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

# FZF é…ç½®
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --inline-info"
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"

# ============================================================================
# å·¥å…·é›†æˆ
# ============================================================================
# Zoxide (æ™ºèƒ½ cd)
if command -v zoxide &> /dev/null; then
    eval "$(zoxide init zsh)"
fi

# FZF é›†æˆ
if command -v fzf &> /dev/null; then
    source <(fzf --zsh)
fi

# TheFuck é›†æˆ
if command -v thefuck &> /dev/null; then
    eval $(thefuck --alias)
fi

# ============================================================================
# æ’ä»¶ç‰¹å®šé…ç½®
# ============================================================================
# zsh-autosuggestions é…ç½®
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#666666,underline"
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20

# zsh-history-substring-search é…ç½®
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
bindkey '^P' history-substring-search-up
bindkey '^N' history-substring-search-down

# you-should-use é…ç½®
export YSU_MESSAGE_POSITION="after"
export YSU_HARDCORE=1

# ============================================================================
# æ™ºèƒ½åˆ«åç³»ç»Ÿ - ä¸Šä¸‹æ–‡æ„ŸçŸ¥
# ============================================================================
# åŸºç¡€å·¥å…·æ›¿æ¢
if command -v exa &> /dev/null; then
    alias ls='exa --icons --group-directories-first'
    alias ll='exa -l --icons --group-directories-first --time-style=long-iso'
    alias la='exa -la --icons --group-directories-first --time-style=long-iso'
    alias lt='exa --tree --level=2 --icons'
    alias lta='exa --tree --level=2 --icons -a'
fi

if command -v bat &> /dev/null; then
    alias cat='bat --paging=never'
    alias less='bat'
fi

if command -v fd &> /dev/null; then
    alias find='fd'
fi

if command -v rg &> /dev/null; then
    alias grep='rg'
fi

# Git å¢å¼ºåˆ«å
alias gst='git status'
alias gco='git checkout'
alias gcb='git checkout -b'
alias gaa='git add .'
alias gcm='git commit -m'
alias gps='git push'
alias gpl='git pull'
alias glog='git log --oneline --graph --decorate --all'
alias gdiff='git diff'
alias gstash='git stash'
alias gpop='git stash pop'

# ç³»ç»Ÿåˆ«å
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias ~='cd ~'
alias -- -='cd -'

# å®ç”¨åˆ«å
alias h='history'
alias j='jobs'
alias c='clear'
alias q='exit'
alias reload='source ~/.zshrc'
alias zshconfig='code ~/.zshrc'

# ç½‘ç»œå·¥å…·
alias myip='curl -s https://ipinfo.io/ip'
alias localip='ipconfig getifaddr en0'
alias ports='lsof -i -P -n | grep LISTEN'

# ç³»ç»Ÿç›‘æ§
alias cpu='top -o cpu'
alias mem='top -o rsize'
alias disk='df -h'
alias temp='sudo powermetrics --samplers smc -n 1 -i 1000 | grep -i temp'

# ============================================================================
# æ™ºèƒ½å‡½æ•° - ä¸Šä¸‹æ–‡æ„ŸçŸ¥æç¤º
# ============================================================================
# æ™ºèƒ½ cd å‡½æ•°
cd() {
    builtin cd "$@"

    # æ˜¾ç¤ºç›®å½•å†…å®¹ï¼ˆå¦‚æœæ–‡ä»¶ä¸å¤šï¼‰
    local file_count=$(ls -1 | wc -l)
    if [[ $file_count -le 20 ]]; then
        echo ""
        if command -v exa &> /dev/null; then
            exa --icons --group-directories-first
        else
            ls -la
        fi
    fi

    # æ£€æŸ¥æ˜¯å¦æ˜¯ Git ä»“åº“
    if git rev-parse --git-dir > /dev/null 2>&1; then
        echo ""
        echo "ğŸ“ Git ä»“åº“: $(basename $(git rev-parse --show-toplevel))"
        echo "ğŸŒ¿ åˆ†æ”¯: $(git branch --show-current)"

        # æ˜¾ç¤ºçŠ¶æ€ï¼ˆå¦‚æœæœ‰å˜æ›´ï¼‰
        if ! git diff-index --quiet HEAD --; then
            echo "ğŸ“ æœ‰æœªæäº¤çš„æ›´æ”¹"
        fi
    fi

    # æ£€æŸ¥æ˜¯å¦æœ‰ Python è™šæ‹Ÿç¯å¢ƒ
    if [[ -f "requirements.txt" ]] || [[ -f "pyproject.toml" ]] || [[ -f "Pipfile" ]]; then
        echo "ğŸ æ£€æµ‹åˆ° Python é¡¹ç›®"
        if [[ -z "$VIRTUAL_ENV" ]]; then
            echo "ğŸ’¡ æç¤º: å¯èƒ½éœ€è¦æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ"
        fi
    fi

    # æ£€æŸ¥æ˜¯å¦æœ‰ Node.js é¡¹ç›®
    if [[ -f "package.json" ]]; then
        echo "ğŸ“¦ æ£€æµ‹åˆ° Node.js é¡¹ç›®"
        if [[ ! -d "node_modules" ]]; then
            echo "ğŸ’¡ æç¤º: è¿è¡Œ 'npm install' å®‰è£…ä¾èµ–"
        fi
    fi

    # æ£€æŸ¥æ˜¯å¦æœ‰ Docker
    if [[ -f "Dockerfile" ]] || [[ -f "docker-compose.yml" ]]; then
        echo "ğŸ³ æ£€æµ‹åˆ° Docker é¡¹ç›®"
    fi
}

# æ™ºèƒ½åˆ›å»ºç›®å½•å¹¶è¿›å…¥
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# å¿«é€Ÿæœç´¢æ–‡ä»¶å†…å®¹
search() {
    if [[ -z "$1" ]]; then
        echo "ç”¨æ³•: search <æœç´¢è¯> [ç›®å½•]"
        return 1
    fi

    local search_term="$1"
    local search_dir="${2:-.}"

    if command -v rg &> /dev/null; then
        rg --color=always --heading --line-number "$search_term" "$search_dir"
    else
        grep -r --color=always -n "$search_term" "$search_dir"
    fi
}

# å¿«é€ŸæŸ¥æ‰¾æ–‡ä»¶
ff() {
    if [[ -z "$1" ]]; then
        echo "ç”¨æ³•: ff <æ–‡ä»¶åæ¨¡å¼>"
        return 1
    fi

    if command -v fd &> /dev/null; then
        fd "$1"
    else
        find . -name "*$1*" -type f
    fi
}

# æ™ºèƒ½å†å²æœç´¢å‡½æ•°
fh() {
    if command -v fzf &> /dev/null; then
        local selected_command=$(history | fzf --tac --no-sort | sed 's/^[ ]*[0-9]*[ ]*//')
        if [[ -n "$selected_command" ]]; then
            print -z "$selected_command"
        fi
    else
        echo "éœ€è¦å®‰è£… fzf æ¥ä½¿ç”¨æ­¤åŠŸèƒ½"
    fi
}

# æ™ºèƒ½è¿›ç¨‹æŸ¥æ‰¾å’Œç®¡ç†
fkill() {
    if command -v fzf &> /dev/null; then
        local pid=$(ps -ef | sed 1d | fzf -m | awk '{print $2}')
        if [[ -n "$pid" ]]; then
            echo "ç»ˆæ­¢è¿›ç¨‹: $pid"
            kill -9 "$pid"
        fi
    else
        echo "éœ€è¦å®‰è£… fzf æ¥ä½¿ç”¨æ­¤åŠŸèƒ½"
    fi
}

# å¿«é€Ÿç¼–è¾‘é…ç½®æ–‡ä»¶
edit_config() {
    local config_files=(
        "~/.zshrc:Zshé…ç½®"
        "~/.gitconfig:Gité…ç½®"
        "~/.condarc:Condaé…ç½®"
        "~/Library/Application Support/Code/User/settings.json:VS Codeè®¾ç½®"
    )

    echo "é€‰æ‹©è¦ç¼–è¾‘çš„é…ç½®æ–‡ä»¶:"
    for i in {1..${#config_files[@]}}; do
        local file_info="${config_files[$i]}"
        local file_path="${file_info%%:*}"
        local file_desc="${file_info##*:}"
        echo "$i) $file_desc ($file_path)"
    done

    read -p "è¯·é€‰æ‹© (1-${#config_files[@]}): " choice

    if [[ "$choice" =~ ^[1-9][0-9]*$ ]] && [[ "$choice" -le "${#config_files[@]}" ]]; then
        local selected="${config_files[$choice]}"
        local file_path="${selected%%:*}"
        local expanded_path="${file_path/#\~/$HOME}"

        if [[ -f "$expanded_path" ]]; then
            $EDITOR "$expanded_path"
        else
            echo "æ–‡ä»¶ä¸å­˜åœ¨: $expanded_path"
        fi
    else
        echo "æ— æ•ˆé€‰æ‹©"
    fi
}

# é¡¹ç›®å¿«é€Ÿå¯åŠ¨å‡½æ•°
project() {
    local project_dir="$HOME/Projects"

    if [[ ! -d "$project_dir" ]]; then
        echo "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $project_dir"
        return 1
    fi

    if command -v fzf &> /dev/null; then
        local selected_project=$(find "$project_dir" -maxdepth 2 -type d | fzf --preview 'ls -la {}')
        if [[ -n "$selected_project" ]]; then
            cd "$selected_project"
        fi
    else
        echo "å¯ç”¨é¡¹ç›®:"
        ls -la "$project_dir"
    fi
}

# ç³»ç»Ÿä¿¡æ¯æ˜¾ç¤º
sysinfo() {
    echo "ğŸ–¥ï¸  ç³»ç»Ÿä¿¡æ¯"
    echo "============"
    echo "ç³»ç»Ÿ: $(uname -s)"
    echo "ç‰ˆæœ¬: $(sw_vers -productVersion)"
    echo "æ¶æ„: $(uname -m)"
    echo "ä¸»æœº: $(hostname)"
    echo "ç”¨æˆ·: $(whoami)"
    echo "Shell: $SHELL"
    echo "ç»ˆç«¯: $TERM"
    echo ""
    echo "ğŸ’¾ å†…å­˜ä½¿ç”¨:"
    vm_stat | grep -E "(free|active|inactive|wired)" | awk '{print $1 " " $3}' | sed 's/://g'
    echo ""
    echo "ğŸ’¿ ç£ç›˜ä½¿ç”¨:"
    df -h / | tail -1 | awk '{print "æ ¹ç›®å½•: " $3 " / " $2 " (" $5 " å·²ä½¿ç”¨)"}'
    echo ""
    echo "ğŸŒ¡ï¸  CPU ä¿¡æ¯:"
    sysctl -n machdep.cpu.brand_string
}

# ç½‘ç»œè¿æ¥æµ‹è¯•
nettest() {
    echo "ğŸŒ ç½‘ç»œè¿æ¥æµ‹è¯•"
    echo "==============="

    local sites=("google.com" "github.com" "stackoverflow.com")

    for site in "${sites[@]}"; do
        if ping -c 1 "$site" &> /dev/null; then
            echo "âœ… $site - è¿æ¥æ­£å¸¸"
        else
            echo "âŒ $site - è¿æ¥å¤±è´¥"
        fi
    done

    echo ""
    echo "ğŸ“¡ æœ¬æœº IP åœ°å€:"
    echo "å†…ç½‘ IP: $(ipconfig getifaddr en0 2>/dev/null || echo 'æœªè¿æ¥')"
    echo "å¤–ç½‘ IP: $(curl -s https://ipinfo.io/ip 2>/dev/null || echo 'è·å–å¤±è´¥')"
}

# ============================================================================
# å‘½ä»¤è®°å¿†å’Œç»Ÿè®¡åŠŸèƒ½
# ============================================================================
# å‘½ä»¤ä½¿ç”¨ç»Ÿè®¡
cmd_stats() {
    echo "ğŸ“Š æœ€å¸¸ç”¨çš„å‘½ä»¤ (Top 20):"
    echo "========================"
    history | awk '{print $2}' | sort | uniq -c | sort -nr | head -20 | \
    awk '{printf "%3d. %-15s (%d æ¬¡)\n", NR, $2, $1}'
}

# ä»Šæ—¥å‘½ä»¤ç»Ÿè®¡
today_stats() {
    local today=$(date +%Y-%m-%d)
    echo "ğŸ“… ä»Šæ—¥å‘½ä»¤ç»Ÿè®¡ ($today):"
    echo "========================"

    # ä»å†å²è®°å½•ä¸­æå–ä»Šæ—¥çš„å‘½ä»¤
    history | grep "$(date +%Y-%m-%d)" | awk '{print $4}' | sort | uniq -c | sort -nr | head -10 | \
    awk '{printf "%3d. %-15s (%d æ¬¡)\n", NR, $2, $1}'
}

# =============================================================================
#                           åŸºç¡€ ZSH é…ç½®æ–‡ä»¶
# =============================================================================

# -----------------------------------------------------------------------------
#                           1. åŸºç¡€å†å²è®°å½•è®¾ç½®
# -----------------------------------------------------------------------------
HISTFILE=~/.zsh_history
HISTSIZE=50000                   # å†…å­˜ä¸­çš„å†å²è®°å½•æ¡æ•°
SAVEHIST=50000                   # å†å²è®°å½•æ–‡ä»¶ä¸­çš„æ¡æ•°

# å†å²è®°å½•è®¾ç½®
setopt EXTENDED_HISTORY          # è®°å½•å‘½ä»¤çš„å¼€å§‹æ—¶é—´æˆ³å’Œæ‰§è¡Œæ—¶é—´
setopt HIST_EXPIRE_DUPS_FIRST   # é¦–å…ˆåˆ é™¤é‡å¤æ¡ç›®
setopt HIST_IGNORE_DUPS         # ä¸è®°å½•é‡å¤çš„å‘½ä»¤
setopt HIST_IGNORE_ALL_DUPS     # å¦‚æœ‰é‡å¤ï¼Œåˆ é™¤æ—§çš„è®°å½•
setopt HIST_FIND_NO_DUPS        # æœç´¢æ—¶ä¸æ˜¾ç¤ºé‡å¤å‘½ä»¤
setopt HIST_IGNORE_SPACE        # ä¸è®°å½•ä»¥ç©ºæ ¼å¼€å¤´çš„å‘½ä»¤
setopt HIST_SAVE_NO_DUPS        # ä¸ä¿å­˜é‡å¤çš„å‘½ä»¤
setopt HIST_VERIFY              # åœ¨æ‰§è¡Œå†å²å‘½ä»¤å‰å…ˆæ˜¾ç¤ºå‘½ä»¤
setopt INC_APPEND_HISTORY       # å®æ—¶è¿½åŠ å†å²è®°å½•
setopt SHARE_HISTORY           # å…±äº«å†å²è®°å½•

# -----------------------------------------------------------------------------
#                           2. å‘½ä»¤è¡¥å…¨ç³»ç»Ÿ
# -----------------------------------------------------------------------------
# åŠ è½½è¡¥å…¨ç³»ç»Ÿ
autoload -Uz compinit && compinit

# è¡¥å…¨é€‰é¡¹
setopt AUTO_LIST               # è‡ªåŠ¨åˆ—å‡ºé€‰é¡¹
setopt AUTO_MENU              # è‡ªåŠ¨ä½¿ç”¨èœå•
setopt COMPLETE_IN_WORD       # åœ¨å•è¯ä¸­ä¹Ÿèƒ½è¡¥å…¨
setopt ALWAYS_TO_END          # è¡¥å…¨åå…‰æ ‡ç§»åˆ°æœ«å°¾

# è¡¥å…¨æ ·å¼è®¾ç½®
zstyle ':completion:*' menu select                 # ä½¿ç”¨èœå•é€‰æ‹©
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' # å¿½ç•¥å¤§å°å†™
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}" # å½©è‰²è¡¥å…¨èœå•
zstyle ':completion:*' verbose yes                 # è¯¦ç»†ä¿¡æ¯
zstyle ':completion:*:descriptions' format '%F{green}-- %d --%f'
zstyle ':completion:*:messages' format '%F{yellow}-- %d --%f'
zstyle ':completion:*:warnings' format '%F{red}-- æ²¡æœ‰åŒ¹é…é¡¹ --%f'

# -----------------------------------------------------------------------------
#                           3. ç¯å¢ƒå˜é‡å’Œè·¯å¾„é…ç½®
# -----------------------------------------------------------------------------
# åŸºç¡€ç¯å¢ƒå˜é‡
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export EDITOR='vim'
export VISUAL='vim'

# PATH é…ç½®
export PATH="/opt/homebrew/bin:$PATH"
export PATH="/usr/local/bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

# -----------------------------------------------------------------------------
#                           4. å®æ—¶å‘½ä»¤å»ºè®®å’Œæ™ºèƒ½è¡¥å…¨
# -----------------------------------------------------------------------------
# åŠ è½½ zsh-autosuggestions æ’ä»¶ï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
if [ -f ~/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh ]; then
    source ~/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh
    # å»ºè®®æ˜¾ç¤ºæ ·å¼
    ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=8'
    ZSH_AUTOSUGGEST_STRATEGY=(history completion)
fi

# åŠ è½½ zsh-syntax-highlighting æ’ä»¶ï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
if [ -f ~/.zsh/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]; then
    source ~/.zsh/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi

# -----------------------------------------------------------------------------
#                           5. é¡¹ç›®ç±»å‹è‡ªåŠ¨æ£€æµ‹
# -----------------------------------------------------------------------------
function detect_project_type() {
    local project_info=""
    
    # Python é¡¹ç›®æ£€æµ‹
    if [[ -f "requirements.txt" ]] || [[ -f "setup.py" ]] || [[ -f "pyproject.toml" ]]; then
        project_info+="ğŸ“¦ Python é¡¹ç›®\n"
        # æ£€æµ‹è™šæ‹Ÿç¯å¢ƒ
        if [[ -d "venv" ]] || [[ -d ".venv" ]]; then
            project_info+="ğŸ”µ å‘ç°è™šæ‹Ÿç¯å¢ƒ\n"
        fi
    fi
    
    # Node.js é¡¹ç›®æ£€æµ‹
    if [[ -f "package.json" ]]; then
        project_info+="âš¡ Node.js é¡¹ç›®\n"
        if [[ ! -d "node_modules" ]]; then
            project_info+="âš ï¸  æç¤º: éœ€è¦è¿è¡Œ npm install\n"
        fi
    fi
    
    # Git ä»“åº“æ£€æµ‹
    if git rev-parse --git-dir > /dev/null 2>&1; then
        project_info+="ğŸŒ¿ Git ä»“åº“: $(git branch --show-current)\n"
    fi

    # Docker é¡¹ç›®æ£€æµ‹
    if [[ -f "Dockerfile" ]] || [[ -f "docker-compose.yml" ]]; then
        project_info+="ğŸ³ Docker é¡¹ç›®\n"
    fi

    [[ -n $project_info ]] && echo "\né¡¹ç›®ä¿¡æ¯:\n$project_info"
}

# -----------------------------------------------------------------------------
#                           6. ç¯å¢ƒçŠ¶æ€ç›‘æ§
# -----------------------------------------------------------------------------
function show_env_info() {
    local env_info=""

    # Python ç¯å¢ƒä¿¡æ¯
    if command -v python &>/dev/null; then
        env_info+="ğŸ Python: $(python --version 2>&1)\n"
        if [[ -n "$VIRTUAL_ENV" ]]; then
            env_info+="   è™šæ‹Ÿç¯å¢ƒ: $(basename $VIRTUAL_ENV)\n"
        fi
    fi

    # Node.js ç¯å¢ƒä¿¡æ¯
    if command -v node &>/dev/null; then
        env_info+="âš¡ Node.js: $(node --version)\n"
    fi

    # Git çŠ¶æ€
    if git rev-parse --git-dir &>/dev/null; then
        local branch=$(git branch --show-current)
        env_info+="ğŸŒ¿ Git åˆ†æ”¯: $branch\n"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
        if ! git diff --quiet; then
            env_info+="   æœ‰æœªæäº¤çš„æ›´æ”¹\n"
        fi
    fi

    echo "\nç¯å¢ƒä¿¡æ¯:\n$env_info"
}

# -----------------------------------------------------------------------------
#                           7. æ™ºèƒ½ CD å‡½æ•°
# -----------------------------------------------------------------------------
function smart_cd() {
    builtin cd "$@"
    detect_project_type
    show_env_info
}

alias cd='smart_cd'

# -----------------------------------------------------------------------------
#                           8. å®ç”¨åˆ«å
# -----------------------------------------------------------------------------
# æ–‡ä»¶åˆ—è¡¨
alias ls='ls -G'
alias ll='ls -lh'
alias la='ls -lah'

# ç›®å½•æ“ä½œ
alias ..='cd ..'
alias ...='cd ../..'
alias mkdir='mkdir -p'

# Git å¿«æ·å‘½ä»¤
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git pull'

# -----------------------------------------------------------------------------
#                           9. æç¤ºç¬¦è®¾ç½®
# -----------------------------------------------------------------------------
# ç®€å•ä½†ä¿¡æ¯ä¸°å¯Œçš„æç¤ºç¬¦
PROMPT='%F{green}%n@%m%f:%F{blue}%~%f$(git_prompt_info)$ '

# Git æç¤ºç¬¦ä¿¡æ¯
autoload -Uz vcs_info
precmd() { vcs_info }
zstyle ':vcs_info:git:*' formats ' (%b)'
setopt prompt_subst
RPROMPT='${vcs_info_msg_0_}'

# -----------------------------------------------------------------------------
#                           10. è‡ªåŠ¨åŠ è½½é…ç½®
# -----------------------------------------------------------------------------
# åŠ è½½æœ¬åœ°é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local

# è¾“å‡ºæ¬¢è¿ä¿¡æ¯
echo "é…ç½®åŠ è½½å®Œæˆï¼ä½¿ç”¨ 'show_env_info' æŸ¥çœ‹ç¯å¢ƒçŠ¶æ€"